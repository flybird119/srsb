```
Creative Commons Legal Code

Attribution-ShareAlike 3.0 Unported

    CREATIVE COMMONS CORPORATION IS NOT A LAW FIRM AND DOES NOT PROVIDE
    LEGAL SERVICES. DISTRIBUTION OF THIS LICENSE DOES NOT CREATE AN
    ATTORNEY-CLIENT RELATIONSHIP. CREATIVE COMMONS PROVIDES THIS
    INFORMATION ON AN "AS-IS" BASIS. CREATIVE COMMONS MAKES NO WARRANTIES
    REGARDING THE INFORMATION PROVIDED, AND DISCLAIMS LIABILITY FOR
    DAMAGES RESULTING FROM ITS USE.
```

# Concurrency

高并发属于高性能的范畴，高性能是什么？下载一个日本的成人武打片，男主人公就是高性能服务器，
也能并发服务好几个客户，那个频率那个幅度，那就是传说中的高性能！过来人都知道，然并卵。

> 备注：高性能高并发，然并卵。

我们做为服务器作者，还是要关注高并发的，为了装更好的B，造出服务更好的B的服务器，
我们就是岛国武打片的导演，不知道高并发也是不行的。SRS2单核，又怎么样？能同时让7500个客户爽，
在流媒体里面你找不到第二个，那个性能是可以优化的，前提得知道这些是怎么回事，
这篇文章就详细分析流服务器的并发问题。

## Goals

到底多少并发是够用的？我们做服务器的到底要支持多少并发？单纯的并发没有意义的，
流服务器的并发需要考虑以下条件：

1. 硬件：CPU，内存，网络。
1. 协议：RTMP，HTTP。
1. 内容：码率。
1. 应用场景：延迟，丢包率，卡顿率。

也就是说，考虑一个1500Kbps平均码率的直播流，延迟在5秒内时，所有客户端均流畅播放，
使用RTMP协议，4核CPU16GB内存10Gbps网络环境，服务器能支持的并发应该是多高？

这么算起来，问题就有点复杂了，不同情况的并发也不一样，让我们做一些简化吧：

1. 硬件：假设网络和内存无限大，CPU只有单核。
1. 协议：只考虑RTMP协议。
1. 内存：以[Sample](http://ossrs.net/srsb/source.200kbps.768x320.flv)标准即200Kbps。
1. 应用场景：3-5秒基本延迟，无丢包，无明显卡顿，也就是基本播放的要求。

> 备注：为何只考虑单核？因为多核具有很好的扩展性，基本上是单核叠加。

> 备注：为何不考虑HTTP？对于流媒体而言，HTTP和RTMP差别不大。

> 备注：为何不考虑内存？现在内存都到64GB级别了，对所有服务器都不是瓶颈。

> 备注：为何不考虑网卡？因为这个是真正的瓶颈。

> 备注：为何真正的瓶颈不考虑，不是瓶颈也不考虑？不是然并卵么？是的。

让我们继续，那么并发的条件变成了：

**单核RTMP能支持多少客户端流畅播放200kbps的直播流？**

在这个条件下，目前的流服务器的指标可能是：

1. Red5: 100个
1. CRTMPD：2000个
1. FMS：2000个
1. NGINX：3000个
1. WOWZA：3000个
1. SRS：7500个

那么我们是不是可以认为流服务器的并发的Goal是2-3k客户端呢？其实，这些服务器的并发是由那个
真正的瓶颈决定的，也就是千兆网络1000Mbps，目前主要的流服务器都是针对千兆网络设计的。
考虑互联网目前的主流码率是500Kbps左右（720p和4K还是不久前的），千兆网络支持多少个客户端？
2000个。千兆网络能支持多少个WEB请求？可能是非常非常大的。

> 备注：流服务器和WEB服务器的差异，在于每个流客户端消耗的带宽比WEB请求大太多了，而且是持续不断的。

这个问题可能会有点残忍：请问流服务器射鸡师，我们把制造1台服务器能服务1亿个客户，结果出口带宽只能扛2000个，
我们是不是有点想多了？因此在千兆网时代，2k并发就是高性能流服务器了，再高又能怎样？

当然那个问题是在千兆网络时代，现在是万兆网络时代了哦，2000个已经是历史了。那么我们到底以多少作为流服务器
的并发，才是正确的Goal呢？

**在这篇文章中，GOAL是流服务器支持的并发越多越好。**

那让我们一起射鸡一个支持越多越好并发的流服务器吧。先了接下我们要做的事情，以及linux能用的API，
毕竟我们还是要用Linux服务器的。

2016.2
