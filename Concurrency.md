```
Creative Commons Legal Code

Attribution-ShareAlike 3.0 Unported

    CREATIVE COMMONS CORPORATION IS NOT A LAW FIRM AND DOES NOT PROVIDE
    LEGAL SERVICES. DISTRIBUTION OF THIS LICENSE DOES NOT CREATE AN
    ATTORNEY-CLIENT RELATIONSHIP. CREATIVE COMMONS PROVIDES THIS
    INFORMATION ON AN "AS-IS" BASIS. CREATIVE COMMONS MAKES NO WARRANTIES
    REGARDING THE INFORMATION PROVIDED, AND DISCLAIMS LIABILITY FOR
    DAMAGES RESULTING FROM ITS USE.
```

# Concurrency

高并发属于高性能的范畴，高性能是什么？下载一个日本的成人武打片，男主人公就是高性能服务器，
也能并发服务好几个客户，那个频率那个幅度，那就是传说中的高性能！过来人都知道，然并卵。

> 备注：高性能高并发，然并卵。

我们做为服务器作者，还是要关注高并发的，为了装更好的B，造出服务更好的B的服务器，
我们就是岛国武打片的导演，不知道高并发也是不行的。SRS2单核，又怎么样？能同时让7500个客户爽，
在流媒体里面你找不到第二个，那个性能是可以优化的，前提得知道这些是怎么回事，
这篇文章就详细分析流服务器的并发问题。

## Goals

到底多少并发是够用的？我们做服务器的到底要支持多少并发？单纯的并发没有意义的，
流服务器的并发需要考虑以下条件：

1. 硬件：CPU，内存，网络。
1. 协议：RTMP，HTTP。
1. 内容：视频平均码率。
1. 应用场景：延迟，丢包率，卡顿率。

也就是说，考虑一个1500Kbps平均码率的直播流，延迟在5秒内时，所有客户端均流畅播放，
使用RTMP协议，4核CPU16GB内存10Gbps网络环境，服务器能支持的并发应该是多高？

这么算起来，问题就有点复杂了，不同情况的并发也不一样，让我们做一些简化吧：

1. 硬件：假设网络和内存无限大，CPU只有单核。
1. 协议：只考虑RTMP协议。
1. 内容：以[Sample](http://ossrs.net/srsb/source.200kbps.768x320.flv)为测试标准即200Kbps。
1. 应用场景：3-5秒基本延迟，无丢包，无明显卡顿，也就是基本播放的要求。

> 备注：为何只考虑单核？因为多核具有很好的扩展性，基本上是单核叠加。

> 备注：为何不考虑HTTP？对于流媒体而言，HTTP和RTMP差别不大。

> 备注：为何不考虑内存？现在内存都到64GB级别了，对所有服务器都不是瓶颈。

> 备注：为何不考虑网卡？因为这个是真正的瓶颈。

> 备注：为何真正的瓶颈不考虑，不是瓶颈也不考虑？不是然并卵么？是的。

让我们继续，那么并发的条件变成了：

**单核RTMP能支持多少客户端流畅播放200kbps的直播流？**

在这个条件下，目前的流服务器的指标可能是：

1. Red5: 100个
1. CRTMPD：2000个
1. FMS：2000个
1. NGINX：3000个
1. WOWZA：3000个
1. SRS：7500个

那么我们是不是可以认为流服务器的并发的Goal是2-3k客户端呢？其实，这些服务器的并发是由那个
真正的瓶颈决定的，也就是千兆网络1000Mbps，目前主要的流服务器都是针对千兆网络设计的。
考虑互联网目前的主流码率是500Kbps左右（720p和4K还是不久前的），千兆网络支持多少个客户端？
2000个。千兆网络能支持多少个WEB请求？可能是非常非常大的。

> 备注：流服务器和WEB服务器的差异，在于每个流客户端消耗的带宽比WEB请求大太多了，而且是持续不断的。

这个问题可能会有点残忍：请问流服务器射鸡师，我们制造能服务1亿个客户的服务器，结果出口带宽只能扛2000个，
我们是不是有点想多了？因此在千兆网时代，2k并发就是高性能流服务器了，再高又能怎样？

当然那个问题是在千兆网络时代，现在是万兆网络时代了哦，2000个已经是历史了。那么我们到底以多少作为流服务器
的并发，才是正确的Goal呢？

并发实际上是一个单独的服务逻辑单元，每个客户端都至少是一个并发；除了客户端，流服务器还需要有以下并发处理：

1. 回源：在流集群中，边缘服务器需要合并回源取流，也就是每个流都会有个并发。
1. 计费和统计：至少需要计算当前带宽，统计人数之类的，这个也是单独的服务单元。
1. 协议转换：回源取RTMP流后，需要转换成HTTP协议提供给客户端，也是独立的服务单元。

以上这些并发虽然不是流服务器主要的性能消耗，却消耗了系统复杂度，一个超复杂的系统也会间接影响提供服务的并发能力。
更重要的是当需要支持新协议，譬如DASH，或者传输方式譬如RTMFP时，过于复杂的系统明显步履维艰。

> 备注：流服务器和WEB服务器的差异，还在于协议、封装和媒体编码，都必须要在服务器完成。

> 备注：WEB服务器能有稳定的那么一天，因为要做的事情是已知的，和业务耦合度低；而流服务器没有结束的那一天。

因此，正确的并发设计在于两点：

1. 在开发人员的理解范围之内，并能持续增加功能应对新需求。
1. 在现有网络条件能支持的最大并发，考虑万兆网络。

> 备注：流服务器系统的根本困难，在于设计一个持续不断增长的服务系统；次要困难是协议解析和性能。

先了解次要困难，关于性能中的并发。从linux能用的API开始，毕竟我们还是要用Linux服务器的。

2016.2
